<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: contribs/gmf/src/directives/layertree.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: contribs/gmf/src/directives/layertree.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>goog.provide('gmf.LayertreeController');
goog.provide('gmf.layertreeDirective');

goog.require('gmf');
goog.require('ngeo.LayerManager');
goog.require('ngeo.LayertreeController');
goog.require('ngeo.layertreeDirective');
goog.require('ol.Collection');
goog.require('ol.layer.Group');
goog.require('ol.layer.Image');
goog.require('ol.source.ImageWMS');


/**
 * @const
 */
gmf.layertreeTemplateUrl = '../src/directives/partials/gmflayertree.html';


/**
 * This directive create a layertree based on a c2cgeoportal JSON themes source
 * and a ngeo.Layertree. The default used template can be overrided by setting
 * the constant 'gmf.layertreeTemplateUrl'. The controller used by this
 * directive defines some fonctions for each node that are created by a default
 * template. This default template can be overrided by setting the constant
 * 'gmf.layertreeTemplateUrl'.
 *
 * @example
 * &lt;gmf-layertree
 *   gmf-layertree-themes="ctrl.themes"
 *   gmf-layertree-map="ctrl.map"
 *   gmf-layertree-wmsurl="ctrl.wmsUrl">
 * &lt;/gmf-layertree>
 *
 * @return {angular.Directive} The directive specs.
 * @ngInject
 * @ngdoc directive
 * @ngname gmfLayertreeDirective
 */

gmf.layertreeDirective = function() {
  return {
    scope: {
      'getMapFn': '&amp;gmfLayertreeMap',
      'getWmsUrlFn': '&amp;gmfLayertreeWmsurl',
      'themes': '=gmfLayertreeThemes'
    },
    controller: 'GmfLayertreeController',
    controllerAs: 'gmfLayertreeCtrl',
    template:
        '&lt;div ngeo-layertree="gmfLayertreeCtrl.tree" ' +
        'ngeo-layertree-map="gmfLayertreeCtrl.map" ' +
        'ngeo-layertree-nodelayer="gmfLayertreeCtrl.getLayer(node)" ' +
        'ngeo-layertree-templateurl="' + gmf.layertreeTemplateUrl + '"' +
        '&lt;div>'
  };
};

gmfModule.directive('gmfLayertree', gmf.layertreeDirective);



/**
 * @param {angular.Scope} $scope The directive's scope.
 * @param {ngeo.LayerManager} ngeoLayerManager Ngeo Layer Manager.
 * @constructor
 * @export
 * @ngInject
 * @ngdoc controller
 * @ngname gmfLayertreeController
 */
gmf.LayertreeController = function($scope, ngeoLayerManager) {

  var map = $scope['getMapFn']();
  goog.asserts.assertInstanceof(map, ol.Map);

  /**
   * @type {!ol.Map}
   * @export
   */
  this.map = map;

  var wmsUrl = $scope['getWmsUrlFn']();
  goog.asserts.assert(goog.isString(wmsUrl));

  /**
   * @type {string}
   * @private
   */
  this.wmsUrl_ = wmsUrl;

  /**
   * @type {ngeo.LayerManager}
   * @private
   */
  this.layerManager_ = ngeoLayerManager;
  this.layerManager_.init(this.map);

  /**
   * @type {Object.&lt;string, function((boolean|undefined)):(boolean|undefined)>}
   * @private
   */
  this.checkboxGettersSetters_ = {};

  /**
   * @type {Object.&lt;string, function():(string|undefined)>}
   * @private
   */
  this.styleStates_ = {};

  //FIXME Choose a theme in gmf datasource
  $scope.$watch('themes', goog.bind(function(newVal) {
    if (goog.isDef(newVal)) {
      this['tree'] = newVal[3];
    }
  }, this));
};


/**
 * Create a return a layer corresponding to the ngeo.layerTree's node.
 * Can currently only creates WMS layers (internal or external) and WMTS layers.
 * @param {GmfThemesNode} node Layer tree node.
 * @return {ol.layer.Layer} The OpenLayers layer or group for the node.
 * @export
 */
gmf.LayertreeController.prototype.getLayer = function(node) {
  var wmsUrl = this.wmsUrl_;
  var layerMgr = this.layerManager_;

  var makeLayers = function(node) {
    var i;
    var children = node.children;
    var layers = new ol.Collection();
    if (goog.isDef(children)) {
      for (i = 0; i &lt; children.length; i++) {
        layers.push(makeLayers(children[i]));
      }
      return layerMgr.createBasicGroup(layers);
    }
    if (node.type === 'external WMS') {
      return layerMgr.createBasicWMSLayer(node.url, node.name);
    } else if (node.type === 'WMTS') {
      return layerMgr.createWMTSLayerFromCapabilitites(node.url, node.name);
    } else {
      return layerMgr.createBasicWMSLayer(wmsUrl, node.name);
    }
  };

  return makeLayers(node);
};


/**
 * Return a Gettersetter function used to set style on each line of the tree.
 * @param {ngeo.LayertreeController} treeCtrl Layer tree controller.
 * @return {function()} Gettersetter function used as Angular model.
 * @export
 */
gmf.LayertreeController.prototype.getStyleGetterSetter =
    function(treeCtrl) {
  var map = this.map;
  var treeCtrlUid = treeCtrl.uid.toString();
  /** @type {function()} */
  var styleState = this.styleStates_[treeCtrlUid];
  if (!goog.isDef(styleState)) {
    styleState = function() {
      return gmf.LayertreeController.getStyleGetterSetter_(treeCtrl, map);
    };
    this.styleStates_[treeCtrlUid] = styleState;
  }
  return styleState;
};


/**
 * Set style of the span element corresponding to the current tree node
 * Current styles:
 *  - Add a 'light' class on nodes out of the current map resolution.
 * @param {ngeo.LayertreeController} treeCtrl Layer tree controller.
 * @param {ol.Map} map
 * @private
 */
gmf.LayertreeController.getStyleGetterSetter_ = function(treeCtrl, map) {
  var possibleClasses = ['light'];
  var classes = [];
  var spans = treeCtrl.element.find('span');
  var span = angular.element(spans[0]);

  //Add class 'light' when out of resolution;
  var resolution = map.getView().getResolution();
  var maxExtent = treeCtrl.node['maxResolutionHint'];
  var minExtent = treeCtrl.node['minResolutionHint'];
  if (goog.isDef(minExtent) &amp;&amp; resolution &lt; minExtent ||
      goog.isDef(maxExtent) &amp;&amp; resolution > maxExtent) {
    classes.push(possibleClasses[0]);
  }

  //update classes on span;
  span.removeClass(possibleClasses.join(' '));
  span.addClass(classes.join(' '));
};


/**
 * Return a Gettersetter function used to set checkbox values and corresponding
 * layers on each line of the tree.
 * @param {ngeo.LayertreeController} treeCtrl Layer tree controller.
 * @return {function((boolean|undefined)):(boolean|undefined)} The checkbox
 *     model getter setter to use for this layer tree controller.
 * @export
 */
gmf.LayertreeController.prototype.getCheckboxGetterSetter =
    function(treeCtrl) {
  var treeCtrlUid = treeCtrl.uid.toString();
  /** @type {function((boolean|undefined)):(boolean|undefined)} */
  var getterSetter = this.checkboxGettersSetters_[treeCtrlUid];
  if (!goog.isDef(getterSetter)) {
    var layerMgr = this.layerManager_;
    getterSetter = function(val) {
      return gmf.LayertreeController.checkboxGetterSetter_(
          treeCtrl, layerMgr, val);
    };
    this.checkboxGettersSetters_[treeCtrlUid] = getterSetter;
  }
  return getterSetter;
};


/**
 * Adapt checkbox or layer to the value of each other.
 * If a value is given, add or remove layer or each layer in a group from the
 * corresponding tree's node.
 * If no value is given, set the checkbox value depending on layers added on
 * the map.
 * @param {ngeo.LayertreeController} treeCtrl Layer tree controller.
 * @param {ngeo.LayerManager} layerMgr Ngeo Layer Manager.
 * @param {boolean|undefined} val Value passed to the model.
 * @return {boolean|undefined} Value to apply on the checkbox.
 * @private
 */
gmf.LayertreeController.checkboxGetterSetter_ = function(treeCtrl, layerMgr,
    val) {
  var node = /** @type {GmfThemesNode} */ (treeCtrl.node);
  var layer = treeCtrl.scope['layer'];
  var layers;

  if (goog.isDef(val)) {
    // If a value is given add or remove layers from this node.
    layers = layerMgr.getFlatLayers(layer);
    layerMgr.moveInOutLayers(layers, val);
  } else {
    // If no value is given, adapt th checkbox state with the map state
    if (goog.isDef(node.children)) {
      // Find number of actives layers on the map from this layer group.
      layers = layerMgr.getFlatLayers(layer);
      var i, nbrLayerOnMap = 0;
      for (i = 0; i &lt; layers.length; i++) {
        if (layerMgr.getLayerIndex(layers[i]) >= 0) {
          nbrLayerOnMap++;
        }
      }
      // Set state of this layer group checkbox
      var checkbox = treeCtrl.element.find('input');
      if (nbrLayerOnMap === layers.length) {
        return true;
      } else if (nbrLayerOnMap > 0) {
        checkbox[0].indeterminate = true;
      } else {
        checkbox[0].indeterminate = false;
        return false;
      }
    } else {
      // Set state of this layer checkbox depending if the corresponding
      // layer is on the map.
      return layerMgr.getLayerIndex(layer) >= 0;
    }
  }
};


/**
 * Set the resolution of the map with node max or min resolution.
 * @param {GmfThemesNode} node Layer tree node.
 * @export
 */
gmf.LayertreeController.prototype.zoomToResolution = function(node) {
  var view = this.map.getView();
  var extent = node['maxResolutionHint'] || node['minResolutionHint'];
  if (goog.isDef(extent)) {
    view.setResolution(extent);
  }
};


gmfModule.controller('GmfLayertreeController', gmf.LayertreeController);
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h2>gmf</h2><h3>Directives</h3><ul><li><a href="gmf.layertreeDirective.html">layertreeDirective</a></li><li><a href="gmf.locationchooserDirective.html">locationchooserDirective</a></li><li><a href="gmf.mapDirective.html">mapDirective</a></li><li><a href="gmf.searchDirective.html">searchDirective</a></li></ul><h3>Controllers</h3><ul><li><a href="gmf.LayertreeController.html">LayertreeController</a></li><li><a href="gmf.LocationchooserController.html">LocationchooserController</a></li><li><a href="gmf.MapController.html">MapController</a></li><li><a href="gmf.SearchController.html">SearchController</a></li></ul><h3>Types</h3><ul><li><a href="gmf.html#ExportFeatures">ExportFeatures</a></li></ul><h3>Enumerations</h3><ul><li><a href="gmf.html#ExportFormat">ExportFormat</a></li></ul><h2>gmf.source</h2><h3>Classes</h3><ul><li><a href="gmf.source.AsitVD.html">AsitVD</a></li><li><a href="gmf.source.Swisstopo.html">Swisstopo</a></li></ul><h2>ngeo</h2><h3>Directives</h3><ul><li><a href="ngeo.btnDirective.html">btnDirective</a></li><li><a href="ngeo.btngroupDirective.html">btngroupDirective</a></li><li><a href="ngeo.controlDirective.html">controlDirective</a></li><li><a href="ngeo.filereaderDirective.html">filereaderDirective</a></li><li><a href="ngeo.layertreeDirective.html">layertreeDirective</a></li><li><a href="ngeo.mapDirective.html">mapDirective</a></li><li><a href="ngeo.modalDirective.html">modalDirective</a></li><li><a href="ngeo.popupDirective.html">popupDirective</a></li><li><a href="ngeo.profileDirective.html">profileDirective</a></li><li><a href="ngeo.resizemapDirective.html">resizemapDirective</a></li><li><a href="ngeo.scaleselectorDirective.html">scaleselectorDirective</a></li><li><a href="ngeo.searchDirective.html">searchDirective</a></li><li><a href="ngeo.sortableDirective.html">sortableDirective</a></li></ul><h3>Services</h3><ul><li><a href="ngeo.BackgroundLayerMgr.html">BackgroundLayerMgr</a></li><li><a href="ngeo.CreateGeoJSONBloodhound.html">CreateGeoJSONBloodhound</a></li><li><a href="ngeo.createPrintServiceFactory.html">createPrintServiceFactory</a></li><li><a href="ngeo.Debounce.html">Debounce</a></li><li><a href="ngeo.DecorateGeolocation.html">DecorateGeolocation</a></li><li><a href="ngeo.DecorateInteraction.html">DecorateInteraction</a></li><li><a href="ngeo.DecorateLayer.html">DecorateLayer</a></li><li><a href="ngeo.FeatureOverlayMgr.html">FeatureOverlayMgr</a></li><li><a href="ngeo.getBrowserLanguageFactory.html">getBrowserLanguageFactory</a></li><li><a href="ngeo.LayerManager.html">LayerManager</a></li><li><a href="ngeo.Location.html">Location</a></li><li><a href="ngeo.Popup.html">Popup</a></li><li><a href="ngeo.PrintUtils.html">PrintUtils</a></li><li><a href="ngeo.SyncArrays.html">SyncArrays</a></li><li><a href="ngeo.ToolActivateMgr.html">ToolActivateMgr</a></li></ul><h3>Controllers</h3><ul><li><a href="ngeo.BtnGroupController.html">BtnGroupController</a></li><li><a href="ngeo.LayertreeController.html">LayertreeController</a></li><li><a href="ngeo.ScaleselectorController.html">ScaleselectorController</a></li></ul><h3>Classes</h3><ul><li><a href="ngeo.BackgroundEvent.html">BackgroundEvent</a></li><li><a href="ngeo.FeatureOverlay.html">FeatureOverlay</a></li><li><a href="ngeo.MeasureEvent.html">MeasureEvent</a></li><li><a href="ngeo.Print.html">Print</a></li><li><a href="ngeo.profile.html">profile</a></li><li><a href="ngeo.ToolActivate.html">ToolActivate</a></li></ul><h3>Types</h3><ul><li><a href="ngeo.html#CreatePopup">CreatePopup</a></li><li><a href="ngeo.html#CreatePrint">CreatePrint</a></li><li><a href="ngeo.html#FeatureOverlayGroup">FeatureOverlayGroup</a></li><li><a href="ngeo.html#GetBrowserLanguage">GetBrowserLanguage</a></li><li><a href="ngeo.html#MockLocationProvider">MockLocationProvider</a></li><li><a href="ngeo.html#ScaleselectorOptions">ScaleselectorOptions</a></li><li><a href="ngeo.html#SortableOptions">SortableOptions</a></li></ul><h3>Enumerations</h3><ul><li><a href="ngeo.html#BackgroundEventType">BackgroundEventType</a></li><li><a href="ngeo.html#MeasureEventType">MeasureEventType</a></li><li><a href="ngeo.html#PrintStyleType">PrintStyleType</a></li></ul><h2>ngeo.format</h2><h3>Classes</h3><ul><li><a href="ngeo.format.FeatureHash.html">FeatureHash</a></li></ul><h3>Enumerations</h3><ul><li><a href="ngeo.format.html#FeatureHashStyleType">FeatureHashStyleType</a></li></ul><h2>ngeo.interaction</h2><h3>Classes</h3><ul><li><a href="ngeo.interaction.DrawAzimut.html">DrawAzimut</a></li><li><a href="ngeo.interaction.Measure.html">Measure</a></li><li><a href="ngeo.interaction.MeasureArea.html">MeasureArea</a></li><li><a href="ngeo.interaction.MeasureAzimut.html">MeasureAzimut</a></li><li><a href="ngeo.interaction.MeasureLength.html">MeasureLength</a></li></ul><h3>Types</h3><ul><li><a href="ngeo.interaction.html#MeasureBaseOptions">MeasureBaseOptions</a></li></ul><h2>ngeo.MeasureEvent</h2><h3>Events</h3><ul><li><a href="ngeo.MeasureEvent.html#event:measureend">measureend</a></li></ul><h2>ngeox</h2><h3>Interfaces</h3><ul><li><a href="ngeox.BackgroundEvent.html">BackgroundEvent</a></li><li><a href="ngeox.MeasureEvent.html">MeasureEvent</a></li></ul><h3>Types</h3><ul><li><a href="ngeox.html#SearchDirectiveListeners">SearchDirectiveListeners</a></li></ul><h2>ngeox.format</h2><h3>Types</h3><ul><li><a href="ngeox.format.html#FeatureHashOptions">FeatureHashOptions</a></li></ul><h2>ngeox.interaction</h2><h3>Types</h3><ul><li><a href="ngeox.interaction.html#MeasureOptions">MeasureOptions</a></li></ul><h2>ngeox.profile</h2><h3>Types</h3><ul><li><a href="ngeox.profile.html#ElevationExtractor">ElevationExtractor</a></li><li><a href="ngeox.profile.html#PoiExtractor">PoiExtractor</a></li><li><a href="ngeox.profile.html#ProfileFormatter">ProfileFormatter</a></li><li><a href="ngeox.profile.html#ProfileOptions">ProfileOptions</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a>
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
